generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  name                   String?
  lineManager            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  tenantId               String?
  orgAssignments         UserOrgAssignment[]
  roles                  UserRole[]
  sessions               Session[]
  tenant                 Tenant?                 @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  kpiChampionAssignments OrgUnitKpiChampion[]
  individualKpis         IndividualKPI[]
  assignedKpis           OrganizationalKPI[]     @relation("AssignedKpis")

  @@map("users")
}

model Tenant {
  id                     String                  @id @default(cuid())
  name                   String
  subdomain              String                  @unique
  settings               Json                    @default("{}")
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  allowedDomains         String[]                @default([])
  fiscalYears            FiscalYear[]
  orgUnits               OrgUnit[]
  perspectives           Perspective[]
  tenantSettings         TenantSettings?
  users                  UserRole[]
  ownerUsers             User[]
  performanceComponents  PerformanceComponent[]

  @@map("tenants")
}

model TenantSettings {
  id                 String   @id @default(cuid())
  tenantId           String   @unique
  terminology        Json     @default("{\"kpis\": \"KPIs\", \"targets\": \"Targets\", \"objectives\": \"Objectives\", \"initiatives\": \"Initiatives\", \"perspectives\": \"Perspectives\"}")
  orgStructureConfig Json     @default("{\"customLevels\": [], \"enabledLevels\": [\"ORGANIZATION\", \"DEPARTMENT\", \"INDIVIDUAL\"]}")
  fiscalYearStart    DateTime @default(dbgenerated("'2025-01-01 00:00:00'::timestamp without time zone"))
  periods            Json     @default("[]")
  branding           Json     @default("{}")
  setupCompleted     Boolean  @default(false)
  setupStep          Int      @default(1)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

model Perspective {
  id          String   @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String?
  color       String   @default("#3B82F6")
  icon        String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@map("perspectives")
}

model Role {
  id          String     @id @default(cuid())
  name        String
  code        String     @unique
  description String?
  permissions Json       @default("[]")
  isSystem    Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  users       UserRole[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, roleId])
  @@map("user_roles")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  csrfToken String?  @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model AuthCode {
  id        String   @id @default(cuid())
  email     String   @unique
  code      String
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("auth_codes")
}

model OrgUnit {
  id                String                    @id @default(cuid())
  tenantId          String
  fiscalYearId      String
  levelDefinitionId String
  code              String
  name              String
  description       String?
  parentId          String?
  isActive          Boolean                   @default(true)
  sortOrder         Int                       @default(0)
  metadata          Json                      @default("{}")
  effectiveFrom     DateTime                  @default(now())
  effectiveTo       DateTime?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  fiscalYear        FiscalYear                @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  levelDefinition   FiscalYearLevelDefinition @relation(fields: [levelDefinitionId], references: [id], onDelete: Cascade)
  parent            OrgUnit?                  @relation("OrgUnitHierarchy", fields: [parentId], references: [id])
  children          OrgUnit[]                 @relation("OrgUnitHierarchy")
  tenant            Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userAssignments   UserOrgAssignment[]
  kpiChampions      OrgUnitKpiChampion[]
  organizationalKpis OrganizationalKPI[]

  @@unique([fiscalYearId, levelDefinitionId, code])
  @@map("org_units")
}

model UserOrgAssignment {
  id            String    @id @default(cuid())
  userId        String
  orgUnitId     String
  role          String?
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  orgUnit       OrgUnit   @relation(fields: [orgUnitId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgUnitId])
  @@map("user_org_assignments")
}

model FiscalYear {
  id                     String                           @id @default(cuid())
  tenantId               String
  name                   String
  startDate              DateTime
  endDate                DateTime
  status                 String                           @default("draft")
  isCurrent              Boolean                          @default(false)
  createdAt              DateTime                         @default(now())
  updatedAt              DateTime                         @updatedAt
  confirmations          FiscalYearConfirmation[]
  levelDefinitions       FiscalYearLevelDefinition[]
  perspectives           FiscalYearPerspective[]
  tenant                 Tenant                           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orgUnits               OrgUnit[]
  cascadeRelationships   PerformanceCascadeRelationship[]
  componentTemplates     PerformanceComponentTemplate[]

  @@unique([tenantId, name])
  @@map("fiscal_years")
}

model FiscalYearLevelDefinition {
  id                     String                           @id @default(cuid())
  fiscalYearId           String
  code                   String
  name                   String
  pluralName             String
  hierarchyLevel         Int
  isStandard             Boolean                          @default(true)
  isEnabled              Boolean                          @default(true)
  isIndividualUnit       Boolean                          @default(false) // Toggle for Individual Unit level
  icon                   String?
  color                  String                           @default("#6B7280")
  metadata               Json                             @default("{}")
  createdAt              DateTime                         @default(now())
  updatedAt              DateTime                         @updatedAt
  fiscalYear             FiscalYear                       @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  orgUnits               OrgUnit[]
  fromCascadeRelations   PerformanceCascadeRelationship[] @relation("FromLevel")
  toCascadeRelations     PerformanceCascadeRelationship[] @relation("ToLevel")
  componentTemplates     PerformanceComponentTemplate[]

  @@unique([fiscalYearId, code])
  @@unique([fiscalYearId, hierarchyLevel])
  @@map("fiscal_year_level_definitions")
}

model FiscalYearConfirmation {
  id               String     @id @default(cuid())
  fiscalYearId     String
  confirmationType String
  confirmedBy      String
  confirmedAt      DateTime
  canModify        Boolean    @default(false)
  metadata         Json?
  createdAt        DateTime   @default(now())
  fiscalYear       FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)

  @@unique([fiscalYearId, confirmationType])
  @@map("fiscal_year_confirmations")
}

model FiscalYearPerspective {
  id            String     @id @default(cuid())
  fiscalYearId  String
  code          String
  name          String
  description   String?
  color         String     @default("#3B82F6")
  icon          String?
  sequenceOrder Int
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  fiscalYear    FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)

  @@unique([fiscalYearId, code])
  @@unique([fiscalYearId, sequenceOrder])
  @@map("fiscal_year_perspectives")
}

model PerformanceComponentTemplate {
  id                 String                           @id @default(cuid())
  fiscalYearId       String
  orgLevelId         String
  componentType      String
  componentName      String
  isStandard         Boolean                          @default(false)
  isMandatory        Boolean                          @default(false)
  sequenceOrder      Int
  metadata           Json                             @default("{}")
  createdAt          DateTime                         @default(now())
  updatedAt          DateTime                         @updatedAt
  entryRelationships PerformanceCascadeRelationship[] @relation("EntryComponent")
  exitRelationships  PerformanceCascadeRelationship[] @relation("ExitComponent")
  fiscalYear         FiscalYear                       @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  orgLevel           FiscalYearLevelDefinition        @relation(fields: [orgLevelId], references: [id], onDelete: Cascade)

  @@unique([fiscalYearId, orgLevelId, componentType])
  @@map("performance_component_templates")
}

model PerformanceCascadeRelationship {
  id               String                       @id @default(cuid())
  fiscalYearId     String
  fromLevelId      String
  toLevelId        String
  exitComponentId  String
  entryComponentId String
  createdAt        DateTime                     @default(now())
  entryComponent   PerformanceComponentTemplate @relation("EntryComponent", fields: [entryComponentId], references: [id], onDelete: Cascade)
  exitComponent    PerformanceComponentTemplate @relation("ExitComponent", fields: [exitComponentId], references: [id], onDelete: Cascade)
  fiscalYear       FiscalYear                   @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  fromLevel        FiscalYearLevelDefinition    @relation("FromLevel", fields: [fromLevelId], references: [id], onDelete: Cascade)
  toLevel          FiscalYearLevelDefinition    @relation("ToLevel", fields: [toLevelId], references: [id], onDelete: Cascade)

  @@map("performance_cascade_relationships")
}

model OrgUnitKpiChampion {
  id        String   @id @default(cuid())
  orgUnitId String
  userId    String
  assignedBy String
  assignedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  orgUnit   OrgUnit  @relation(fields: [orgUnitId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgUnitId, userId])
  @@map("org_unit_kpi_champions")
}

model PerformanceComponent {
  id                    String                  @id @default(cuid())
  tenantId              String
  name                  String
  description           String?
  organizationalLevel   String
  weight                Float                   @default(1.0)
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  tenant                Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  individualKpis        IndividualKPI[]
  organizationalKpis    OrganizationalKPI[]

  @@unique([tenantId, name, organizationalLevel], name: "tenantId_name_organizationalLevel")
  @@map("performance_components")
}

model IndividualKPI {
  id           String                @id @default(cuid())
  userId       String
  componentId  String
  name         String
  description  String?
  targetValue  Float
  currentValue Float                 @default(0)
  unit         String
  status       String                @default("NOT_STARTED")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  component    PerformanceComponent  @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@map("individual_kpis")
}

model OrganizationalKPI {
  id                     String                @id @default(cuid())
  organizationalUnitId   String
  componentId            String
  name                   String
  description            String?
  targetValue            Float
  currentValue           Float                 @default(0)
  unit                   String
  status                 String                @default("NOT_STARTED")
  assignedById           String
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  
  organizationalUnit     OrgUnit               @relation(fields: [organizationalUnitId], references: [id], onDelete: Cascade)
  component              PerformanceComponent  @relation(fields: [componentId], references: [id], onDelete: Cascade)
  assignedBy             User                  @relation("AssignedKpis", fields: [assignedById], references: [id], onDelete: Cascade)

  @@map("organizational_kpis")
}
